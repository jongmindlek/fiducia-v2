<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./style.css"/>
  <title>Crew | Fiducia Collective</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand">FIDUCIA COLLECTIVE</div>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h2>crew</h2>

    <section class="card" style="margin-top:12px">
      <div class="row" style="gap:8px; flex-wrap:wrap">
        <input id="q" class="input" placeholder="이름/키워드 검색" style="flex:1; min-width:160px"/>
        <select id="skillSel" class="select">
          <option value="">Skill 전체</option>
        </select>
        <select id="roleSel" class="select">
          <option value="">Role 전체</option>
          <option value="director">director</option>
          <option value="staff">staff</option>
        </select>
        <label class="row small" style="gap:6px">
          <input id="verifiedOnly" type="checkbox"/>
          Verified만
        </label>
      </div>
    </section>

    <section class="section">
      <h3>Directors</h3>
      <div id="directors" class="list"></div>
      <div id="directorsEmpty" class="small" style="display:none">Director 없음</div>
    </section>

    <section class="section">
      <h3>Staff</h3>
      <div id="staff" class="list"></div>
      <div id="staffEmpty" class="small" style="display:none">Staff 없음</div>
    </section>

    <section class="section card" id="register">
      <h3>crew register</h3>
      <p class="small">
        감독/스태프 등록은 먼저 정보 접수 → 카톡으로 면접 조율 → 승인 후 등록되는 방식입니다.
      </p>
      <a class="cta" href="https://open.kakao.com/o/여기에너링크" target="_blank">
        내 카톡으로 정보 보내기
      </a>
    </section>
  </main>

  <script type="module">
    const directorsEl = document.querySelector("#directors");
    const staffEl = document.querySelector("#staff");
    const directorsEmpty = document.querySelector("#directorsEmpty");
    const staffEmpty = document.querySelector("#staffEmpty");

    const qEl = document.querySelector("#q");
    const skillSel = document.querySelector("#skillSel");
    const roleSel = document.querySelector("#roleSel");
    const verifiedOnly = document.querySelector("#verifiedOnly");

    let data = [];

    function cardHTML(p){
      const img = p.profileImageUrl
        ? `<img src="${p.profileImageUrl}" alt="" loading="lazy"/>`
        : `<div class="thumb">no image</div>`;

      return `
        <a class="card person" href="./crew-detail.html?id=${p.id}">
          <div class="thumb">${img}</div>
          <div class="name">${p.name || "Unnamed"}</div>
          <div class="small">${p.bio || ""}</div>
          <div class="tags">
            ${p.roles.map(r => `<span class="tag">${r}</span>`).join("")}
            ${p.skills.map(s => `<span class="tag">${s}</span>`).join("")}
            ${p.verified ? `<span class="tag">Verified</span>` : ""}
          </div>
        </a>
      `;
    }

    function render(){
      const q = qEl.value.trim().toLowerCase();
      const sk = skillSel.value;
      const rl = roleSel.value;
      const ver = verifiedOnly.checked;

      const filtered = data.filter(p=>{
        if (q && !(p.name||"").toLowerCase().includes(q) && !(p.bio||"").toLowerCase().includes(q)) return false;
        if (sk && !p.skills.includes(sk)) return false;
        if (rl && p.mainRole !== rl) return false;
        if (ver && !p.verified) return false;
        return true;
      });

      const dirs = filtered.filter(x=>x.mainRole==="director");
      const stf  = filtered.filter(x=>x.mainRole==="staff");

      directorsEl.innerHTML = dirs.map(cardHTML).join("");
      staffEl.innerHTML = stf.map(cardHTML).join("");

      directorsEmpty.style.display = dirs.length ? "none" : "block";
      staffEmpty.style.display = stf.length ? "none" : "block";
    }

    async function load(){
      const res = await fetch("/api/crew");
      data = await res.json();

      // skill 옵션 채우기
      const allSkills = [...new Set(data.flatMap(x => x.skills || []))].sort();
      allSkills.forEach(s=>{
        const opt = document.createElement("option");
        opt.value = s; opt.textContent = s;
        skillSel.appendChild(opt);
      });

      render();
    }

    [qEl, skillSel, roleSel, verifiedOnly].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    load();
  </script>
</body>
</html>