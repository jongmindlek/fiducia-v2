<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./style.css"/>
  <title>Crew | Fiducia Collective</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <a class="brand" href="./index.html">
        <div class="brand-title">Fiducia</div>
        <div class="brand-sub">COLLECTIVE</div>
      </a>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
        <a class="tab" href="./crew.html#register">감독/스태프 등록</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <div class="grid">

      <!-- filter -->
      <section class="card" style="grid-column: span 12;">
        <h3>crew</h3>

        <div class="form" style="margin-top:10px">
          <div class="full">
            <label>이름/키워드 검색</label>
            <input id="q" placeholder="이름, 역할, 스킬 등 검색"/>
          </div>

          <div>
            <label>Skill</label>
            <select id="skill">
              <option value="">Skill 전체</option>
            </select>
          </div>

          <div>
            <label>Role</label>
            <select id="role">
              <option value="">Role 전체</option>
              <option value="director">Director</option>
              <option value="staff">Staff</option>
            </select>
          </div>

          <div class="full row" style="margin-top:2px">
            <input id="verifiedOnly" type="checkbox" style="width:auto"/>
            <label for="verifiedOnly" style="margin:0">Verified만</label>
          </div>
        </div>
      </section>

      <!-- directors -->
      <section class="card" style="grid-column: span 12;">
        <h3>Directors</h3>
        <div id="directors" class="list" style="margin-top:10px"></div>
        <div id="directorsEmpty" class="small" style="margin-top:8px;display:none">Director 없음</div>
      </section>

      <!-- staff -->
      <section class="card" style="grid-column: span 12;">
        <h3>Staff</h3>
        <div id="staff" class="list" style="margin-top:10px"></div>
        <div id="staffEmpty" class="small" style="margin-top:8px;display:none">Staff 없음</div>
      </section>

      <!-- register -->
      <section id="register" class="card" style="grid-column: span 12;">
        <h3>crew register</h3>
        <p class="small">
          감독/스태프 등록은 면접 후 “Verified” 처리된 분만 리스트에 노출됩니다.<br/>
          아래 버튼으로 지원 정보를 **개인 카톡**으로 보내주세요.
        </p>

        <!-- ✅ 여기만 네 카톡 링크로 바꿔줘 -->
        <!-- 예: https://open.kakao.com/o/xxxxxx 또는 카카오톡 나에게 보내기 링크 -->
        <a id="kakaoBtn" class="btn" href="KAKAO_LINK" target="_blank" rel="noreferrer">
          카톡으로 지원정보 보내기
        </a>

        <div class="small" style="margin-top:8px;line-height:1.7">
          보내야 할 정보: 이름 / 역할(감독 or 스태프) / 스킬 / 포폴 링크 /
          연락처 / 간단 소개
        </div>
      </section>

    </div>
  </main>

  <footer class="footer">
    <div class="container row" style="justify-content:space-between">
      <div>© Fiducia Collective</div>
      <div class="row">
        <a class="small" href="https://instagram.com" target="_blank" rel="noreferrer">Instagram</a>
      </div>
    </div>
  </footer>

  <script type="module">
    const els = {
      q: document.querySelector("#q"),
      skill: document.querySelector("#skill"),
      role: document.querySelector("#role"),
      verifiedOnly: document.querySelector("#verifiedOnly"),
      directors: document.querySelector("#directors"),
      staff: document.querySelector("#staff"),
      directorsEmpty: document.querySelector("#directorsEmpty"),
      staffEmpty: document.querySelector("#staffEmpty")
    };

    let CREW = [];

    const renderPeople = (list, mount, emptyEl) => {
      mount.innerHTML = "";
      if(!list.length){
        emptyEl.style.display = "block";
        return;
      }
      emptyEl.style.display = "none";
      list.forEach(p=>{
        const a = document.createElement("a");
        a.className = "person";
        a.href = p.portfolioUrl || p.instagram || "#";
        a.target = "_blank";
        a.rel = "noreferrer";
        a.innerHTML = `
          <div class="thumb">
            ${p.profileImageUrl ? `<img src="${p.profileImageUrl}" alt="${p.name||"crew"}"/>`
                               : `<span class="small">no image</span>`}
          </div>
          <div class="name">${p.name || "Untitled"}</div>
          <div class="small">${p.bio || ""}</div>
          <div class="tags">
            ${(p.roles||[]).map(r=>`<span class="tag">${r}</span>`).join("")}
            ${(p.skills||[]).map(s=>`<span class="tag">${s}</span>`).join("")}
            ${p.verified ? `<span class="tag">Verified</span>` : ""}
          </div>
        `;
        mount.appendChild(a);
      });
    };

    const applyFilters = () => {
      const q = els.q.value.trim().toLowerCase();
      const skill = els.skill.value;
      const role = els.role.value;
      const verifiedOnly = els.verifiedOnly.checked;

      const filtered = CREW.filter(p=>{
        if(verifiedOnly && !p.verified) return false;
        if(role && p.mainRole !== role) return false;
        if(skill && !(p.skills||[]).includes(skill)) return false;

        if(!q) return true;
        const blob = [
          p.name, p.bio, p.mainRole,
          ...(p.roles||[]), ...(p.skills||[])
        ].join(" ").toLowerCase();
        return blob.includes(q);
      });

      renderPeople(filtered.filter(p=>p.mainRole==="director"), els.directors, els.directorsEmpty);
      renderPeople(filtered.filter(p=>p.mainRole==="staff"), els.staff, els.staffEmpty);
    };

    async function loadCrew(){
      try{
        const res = await fetch("/api/crew");
        const data = await res.json();

        // ✅ 에러가 오면 화면에 그대로 보여주기
        if(!Array.isArray(data)){
          CREW = [];
          els.directorsEmpty.style.display="block";
          els.directorsEmpty.textContent="crew 불러오기 실패";
          els.staffEmpty.style.display="block";
          els.staffEmpty.textContent="crew 불러오기 실패";
          return;
        }

        CREW = data;

        // skill 옵션 자동 구성
        const allSkills = [...new Set(CREW.flatMap(p=>p.skills||[]))].sort();
        els.skill.innerHTML = `<option value="">Skill 전체</option>` +
          allSkills.map(s=>`<option value="${s}">${s}</option>`).join("");

        applyFilters();
      }catch(e){
        els.directorsEmpty.style.display="block";
        els.directorsEmpty.textContent="crew 불러오기 실패";
        els.staffEmpty.style.display="block";
        els.staffEmpty.textContent="crew 불러오기 실패";
      }
    }

    ["input","change"].forEach(evt=>{
      els.q.addEventListener(evt, applyFilters);
      els.skill.addEventListener(evt, applyFilters);
      els.role.addEventListener(evt, applyFilters);
      els.verifiedOnly.addEventListener(evt, applyFilters);
    });

    loadCrew();
  </script>
</body>
</html>