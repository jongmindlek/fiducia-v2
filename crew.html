<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./style.css"/>
  <title>Crew | Fiducia Collective</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand">FIDUCIA COLLECTIVE</div>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
        <a class="tab" href="./crew.html#register">감독/스태프 등록</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h2 style="margin-bottom:12px;">crew</h2>

    <section class="card soft" style="grid-column: span 12; margin-bottom:12px;">
      <div class="filters">
        <input id="q" class="input" placeholder="이름/키워드 검색"/>
        <select id="skill">
          <option value="">Skill 전체</option>
        </select>
        <select id="role">
          <option value="">Role 전체</option>
        </select>
      </div>

      <label class="checkline">
        <input id="onlyVerified" type="checkbox"/>
        <span>Verified만</span>
      </label>
    </section>

    <section class="card" style="margin-bottom:12px;">
      <h3>Directors</h3>
      <div id="directors" class="list"></div>
      <div id="directorsEmpty" class="small" style="margin-top:8px; display:none;">Director 없음</div>
    </section>

    <section class="card">
      <h3>Staff</h3>
      <div id="staff" class="list"></div>
      <div id="staffEmpty" class="small" style="margin-top:8px; display:none;">Staff 없음</div>
    </section>

    <section id="register" class="card soft" style="margin-top:14px;">
      <h3>crew register</h3>
      <p class="muted">
        감독/스태프 등록은 <b>면접 후 “Verified” 처리된 분만</b> 리스트에 노출됩니다.<br/>
        아래 버튼으로 지원 정보를 <b>개인 카톡</b>으로 보내주세요.
      </p>

      <!-- TODO: 여기 카카오톡 링크만 네 개인 링크로 교체 -->
      <a class="btn" style="display:inline-flex;align-items:center;justify-content:center;margin-top:12px;text-decoration:none;"
         href="https://open.kakao.com/o/여기네링크"
         target="_blank" rel="noreferrer">
        카톡으로 지원정보 보내기
      </a>

      <div class="notice" style="margin-top:10px;">
        보내야 할 정보: 이름 / 역할(감독 or 스태프) / 스킬 / 포폴 링크 / 연락처 / 간단 소개
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container row" style="justify-content:space-between">
      <div>© Fiducia Collective</div>
      <div class="row">
        <span>Instagram</span>
        <span>Contact</span>
      </div>
    </div>
  </footer>

  <script type="module">
    const directorsEl = document.querySelector("#directors");
    const staffEl = document.querySelector("#staff");
    const directorsEmpty = document.querySelector("#directorsEmpty");
    const staffEmpty = document.querySelector("#staffEmpty");

    const qEl = document.querySelector("#q");
    const skillEl = document.querySelector("#skill");
    const roleEl = document.querySelector("#role");
    const onlyVerifiedEl = document.querySelector("#onlyVerified");

    let crews = [];

    const thumb = (url) => url
      ? `<img src="${url}" alt="thumbnail" loading="lazy"/>`
      : `<div class="thumb">no image</div>`;

    function uniq(list){ return [...new Set(list.filter(Boolean))]; }

    function fillOptions(){
      const skills = uniq(crews.flatMap(c => c.skills || []));
      const roles = uniq(crews.flatMap(c => c.roles || []));
      skills.forEach(s=>{
        const opt=document.createElement("option");
        opt.value=s; opt.textContent=s;
        skillEl.appendChild(opt);
      });
      roles.forEach(r=>{
        const opt=document.createElement("option");
        opt.value=r; opt.textContent=r;
        roleEl.appendChild(opt);
      });
    }

    function applyFilter(){
      const q = (qEl.value||"").toLowerCase().trim();
      const skill = skillEl.value;
      const role = roleEl.value;
      const onlyVerified = onlyVerifiedEl.checked;

      const filtered = crews.filter(c=>{
        const name = (c.name||"").toLowerCase();
        const bio = (c.bio||"").toLowerCase();
        const kws = [name,bio,(c.skills||[]).join(" ").toLowerCase(),(c.roles||[]).join(" ").toLowerCase()].join(" ");

        if(q && !kws.includes(q)) return false;
        if(skill && !(c.skills||[]).includes(skill)) return false;
        if(role && !(c.roles||[]).includes(role)) return false;
        if(onlyVerified && !c.verified) return false;
        return true;
      });

      render(filtered);
    }

    function render(list){
      directorsEl.innerHTML = "";
      staffEl.innerHTML = "";

      const directors = list.filter(c=>c.mainRole==="director");
      const staff = list.filter(c=>c.mainRole==="staff");

      directorsEmpty.style.display = directors.length? "none":"block";
      staffEmpty.style.display = staff.length? "none":"block";

      directors.forEach(c=>{
        const a=document.createElement("a");
        a.className="card person";
        a.href=`./crew-detail.html?id=${encodeURIComponent(c.id)}`;
        a.innerHTML=`
          <div class="thumb">${thumb(c.profileImageUrl)}</div>
          <div class="name">${c.name||"Unnamed"}</div>
          <div class="small">${c.bio||""}</div>
          <div class="tags">
            ${(c.roles||[]).map(r=>`<span class="tag">${r}</span>`).join("")}
            ${(c.skills||[]).map(s=>`<span class="tag">${s}</span>`).join("")}
            ${c.verified?`<span class="tag">Verified</span>`:""}
          </div>
        `;
        directorsEl.appendChild(a);
      });

      staff.forEach(c=>{
        const a=document.createElement("a");
        a.className="card person";
        a.href=`./crew-detail.html?id=${encodeURIComponent(c.id)}`;
        a.innerHTML=`
          <div class="thumb">${thumb(c.profileImageUrl)}</div>
          <div class="name">${c.name||"Unnamed"}</div>
          <div class="small">${c.bio||""}</div>
          <div class="tags">
            ${(c.roles||[]).map(r=>`<span class="tag">${r}</span>`).join("")}
            ${(c.skills||[]).map(s=>`<span class="tag">${s}</span>`).join("")}
            ${c.verified?`<span class="tag">Verified</span>`:""}
          </div>
        `;
        staffEl.appendChild(a);
      });
    }

    async function loadCrew(){
      try{
        const res= await fetch("/api/crew");
        crews = await res.json();
        if(!Array.isArray(crews)) crews=[];
        fillOptions();
        applyFilter();
      }catch(e){
        directorsEmpty.style.display="block";
        staffEmpty.style.display="block";
        directorsEmpty.textContent="crew 불러오기 실패";
        staffEmpty.textContent="crew 불러오기 실패";
      }
    }

    ["input","change"].forEach(ev=>{
      qEl.addEventListener(ev, applyFilter);
      skillEl.addEventListener(ev, applyFilter);
      roleEl.addEventListener(ev, applyFilter);
      onlyVerifiedEl.addEventListener(ev, applyFilter);
    });

    loadCrew();
  </script>
</body>
</html>