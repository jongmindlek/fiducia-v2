<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>Crew | Fiducia Collective</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <a class="brand" href="./index.html">
        <span class="brand-top">Fiducia</span>
        <span class="brand-bottom">COLLECTIVE</span>
      </a>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
        <a class="tab" href="./crew.html#register">감독/스태프 등록</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h1 class="page-title">crew</h1>

    <section class="card">
      <div class="filters">
        <input id="q" class="input" placeholder="이름/키워드 검색"/>
        <select id="skill" class="input">
          <option value="">Skill 전체</option>
        </select>
        <select id="role" class="input">
          <option value="">Role 전체</option>
          <option value="director">Director</option>
          <option value="staff">Staff</option>
        </select>
        <label class="checkbox">
          <input type="checkbox" id="verifiedOnly"/>
          <span>Verified만</span>
        </label>
      </div>
    </section>

    <section class="crew-section">
      <h2>Directors</h2>
      <div id="directors" class="list"></div>
      <div id="directorsEmpty" class="small empty">Director 없음</div>
    </section>

    <section class="crew-section">
      <h2>Staff</h2>
      <div id="staff" class="list"></div>
      <div id="staffEmpty" class="small empty">Staff 없음</div>
    </section>

    <section id="register" class="card register-card">
      <h3>crew register</h3>
      <p class="small">
        감독/스태프 등록은 면접 후 “Verified” 처리된 분만 리스트에 노출됩니다.<br/>
        아래 버튼으로 지원 정보를 <b>개인 카톡(나에게)</b>으로 보내주세요.
      </p>
      <a class="cta wide" id="kakaoBtn" href="#" target="_blank" rel="noreferrer">
        카톡으로 지원정보 보내기
      </a>
      <div class="hint small">
        보내야 할 정보: 이름 / 역할(감독 or 스태프) / 스킬 / 포폴 링크 / 연락처 / 간단 소개
      </div>
    </section>
  </main>

  <script type="module">
    const $ = (s)=>document.querySelector(s);
    const directorsEl = $("#directors");
    const staffEl = $("#staff");
    const directorsEmpty = $("#directorsEmpty");
    const staffEmpty = $("#staffEmpty");
    const qEl = $("#q");
    const skillEl = $("#skill");
    const roleEl = $("#role");
    const verifiedOnlyEl = $("#verifiedOnly");

    let crew = [];

    function render(){
      const q = qEl.value.trim().toLowerCase();
      const skill = skillEl.value;
      const role = roleEl.value;
      const verifiedOnly = verifiedOnlyEl.checked;

      const filtered = crew.filter(p=>{
        if(verifiedOnly && !p.verified) return false;
        if(role && p.mainRole !== role) return false;
        if(skill && !(p.skills||[]).includes(skill)) return false;
        if(q){
          const blob = [
            p.name, p.bio, p.mainRole,
            ...(p.skills||[]), ...(p.roles||[])
          ].join(" ").toLowerCase();
          if(!blob.includes(q)) return false;
        }
        return true;
      });

      const directors = filtered.filter(p=>p.mainRole==="director");
      const staff = filtered.filter(p=>p.mainRole==="staff");

      const cardHTML = (p)=>`
        <a class="card person" href="./crew-detail.html?id=${p.id}">
          <div class="thumb">
            ${
              p.profileImageUrl
                ? `<img src="${p.profileImageUrl}" alt="${p.name}" loading="lazy"/>`
                : `<div class="thumb noimg">no image</div>`
            }
          </div>
          <div class="name">${p.name || "이름 없음"}</div>
          <div class="small">${p.bio || ""}</div>
          <div class="tags">
            ${(p.roles||[]).map(r=>`<span class="tag">${r}</span>`).join("")}
            ${(p.skills||[]).map(s=>`<span class="tag outline">${s}</span>`).join("")}
            ${p.verified ? `<span class="tag verified">Verified</span>` : ""}
          </div>
        </a>
      `;

      directorsEl.innerHTML = directors.map(cardHTML).join("");
      staffEl.innerHTML = staff.map(cardHTML).join("");

      directorsEmpty.style.display = directors.length ? "none" : "block";
      staffEmpty.style.display = staff.length ? "none" : "block";
    }

    function fillSkillOptions(){
      const set = new Set();
      crew.forEach(p => (p.skills||[]).forEach(s=>set.add(s)));
      [...set].sort().forEach(s=>{
        const op=document.createElement("option");
        op.value=s; op.textContent=s;
        skillEl.appendChild(op);
      });
    }

    async function loadCrew(){
      try{
        const res = await fetch("/api/crew");
        crew = await res.json();
        if(!Array.isArray(crew)) crew = [];
        fillSkillOptions();
        render();
      }catch(e){
        directorsEmpty.textContent="Crew 불러오기 실패";
        staffEmpty.textContent="Crew 불러오기 실패";
        directorsEmpty.style.display="block";
        staffEmpty.style.display="block";
      }
    }

    [qEl, skillEl, roleEl, verifiedOnlyEl].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    // 개인 카톡으로 보내기 (너 카톡 번호로 바꿔)
    const KAKAO_TARGET = "010xxxxxxxx"; // <- 여기에 네 번호
    const msg = encodeURIComponent(
      "Fiducia Crew 지원합니다.\n이름:\n역할(감독/스태프):\n스킬:\n포폴 링크:\n연락처:\n간단 소개:"
    );
    $("#kakaoBtn").href = `sms:${KAKAO_TARGET}?&body=${msg}`;

    loadCrew();
  </script>
</body>
</html>