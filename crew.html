<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./style.css"/>
  <title>Fiducia Collective — Crew</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand">FIDUCIA COLLECTIVE</div>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
        <a class="tab" href="./crew.html#register">감독/스태프 등록</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <header class="row" style="align-items:center;justify-content:space-between;margin-bottom:12px;">
      <h1 style="margin:0;">crew</h1>
    </header>

    <!-- Filters -->
    <section class="card" style="margin-bottom:16px;">
      <div class="grid" style="gap:10px;">
        <div style="grid-column: span 12;">
          <input id="q" class="input" placeholder="이름/키워드 검색" />
        </div>

        <div style="grid-column: span 6;">
          <label class="small" style="display:block;margin-bottom:6px;">Skill</label>
          <select id="skill" class="input">
            <option value="">Skill 전체</option>
          </select>
        </div>

        <div style="grid-column: span 6;">
          <label class="small" style="display:block;margin-bottom:6px;">Role</label>
          <select id="role" class="input">
            <option value="">Role 전체</option>
          </select>
        </div>
      </div>
    </section>

    <!-- Directors -->
    <section class="section">
      <h2 style="margin-bottom:8px;">Directors</h2>
      <div id="directors" class="list"></div>
      <div id="directorsEmpty" class="small" style="display:none;">Director 없음</div>
    </section>

    <!-- Staff -->
    <section class="section" style="margin-top:22px;">
      <h2 style="margin-bottom:8px;">Staff</h2>
      <div id="staff" class="list"></div>
      <div id="staffEmpty" class="small" style="display:none;">Staff 없음</div>
    </section>

    <!-- Register -->
    <section id="register" class="section" style="margin-top:28px;">
      <div class="card">
        <h3>crew register</h3>
        <p class="small" style="line-height:1.6;">
          감독/스태프 등록은 면접 후 등록됩니다.<br/>
          아래 버튼으로 지원 정보를 <b>개인 카톡(나에게)</b>으로 보내주세요.
        </p>

        <a
          class="cta"
          style="display:inline-flex;align-items:center;justify-content:center;padding:14px 18px;margin-top:10px;"
          href="https://open.kakao.com/o/sYOUR_KAKAO_LINK"
          target="_blank" rel="noreferrer"
        >
          카톡으로 지원정보 보내기
        </a>

        <div class="small" style="margin-top:10px;opacity:.8;">
          보내야 할 정보: 이름 / 역할(감독 or 스태프) / 스킬 / 포폴 링크 / 연락처 / 간단 소개
        </div>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="container row" style="justify-content:space-between">
      <div>© Fiducia Collective</div>
      <div class="row">
        <span>Instagram</span>
        <span>Contact</span>
      </div>
    </div>
  </footer>

  <script type="module">
    const directorsEl = document.querySelector("#directors");
    const staffEl = document.querySelector("#staff");
    const directorsEmpty = document.querySelector("#directorsEmpty");
    const staffEmpty = document.querySelector("#staffEmpty");

    const qEl = document.querySelector("#q");
    const skillEl = document.querySelector("#skill");
    const roleEl = document.querySelector("#role");

    let allCrew = [];

    const thumb = (url) => url
      ? `<img src="${url}" alt="profile" loading="lazy"/>`
      : `<div class="thumb">no image</div>`;

    function uniq(arr){
      return [...new Set(arr.filter(Boolean))].sort();
    }

    function fillSelect(select, values){
      const keepFirst = select.querySelector("option[value='']");
      select.innerHTML = "";
      select.appendChild(keepFirst);
      values.forEach(v=>{
        const op = document.createElement("option");
        op.value = v;
        op.textContent = v;
        select.appendChild(op);
      });
    }

    function matchesFilters(item){
      const q = qEl.value.trim().toLowerCase();
      const skill = skillEl.value;
      const role = roleEl.value;

      if (q){
        const hay = [
          item.name, item.bio, item.instagram, item.phone, item.email,
          ...(item.roles||[]), ...(item.skills||[])
        ].join(" ").toLowerCase();
        if (!hay.includes(q)) return false;
      }
      if (skill && !(item.skills||[]).includes(skill)) return false;
      if (role && !(item.roles||[]).includes(role)) return false;

      return true;
    }

    function render(){
      directorsEl.innerHTML = "";
      staffEl.innerHTML = "";

      const filtered = allCrew.filter(matchesFilters);

      const directors = filtered.filter(c => c.mainRole === "director");
      const staff = filtered.filter(c => c.mainRole === "staff");

      directorsEmpty.style.display = directors.length ? "none" : "block";
      staffEmpty.style.display = staff.length ? "none" : "block";

      directors.forEach(c=>{
        const a = document.createElement("a");
        a.className = "card person";
        a.href = c.id ? `./crew-detail.html?id=${c.id}` : "#";
        a.innerHTML = `
          <div class="thumb">${thumb(c.profileImageUrl)}</div>
          <div class="name">${c.name || "Unnamed"}</div>
          <div class="small">${c.bio || ""}</div>
          <div class="tags">
            ${(c.roles||[]).slice(0,4).map(r=>`<span class="tag">${r}</span>`).join("")}
            ${(c.skills||[]).slice(0,4).map(s=>`<span class="tag">${s}</span>`).join("")}
          </div>
        `;
        directorsEl.appendChild(a);
      });

      staff.forEach(c=>{
        const a = document.createElement("a");
        a.className = "card person";
        a.href = c.id ? `./crew-detail.html?id=${c.id}` : "#";
        a.innerHTML = `
          <div class="thumb">${thumb(c.profileImageUrl)}</div>
          <div class="name">${c.name || "Unnamed"}</div>
          <div class="small">${c.bio || ""}</div>
          <div class="tags">
            ${(c.roles||[]).slice(0,4).map(r=>`<span class="tag">${r}</span>`).join("")}
            ${(c.skills||[]).slice(0,4).map(s=>`<span class="tag">${s}</span>`).join("")}
          </div>
        `;
        staffEl.appendChild(a);
      });
    }

    async function loadCrew(){
      directorsEl.innerHTML = "";
      staffEl.innerHTML = "";
      directorsEmpty.style.display = "none";
      staffEmpty.style.display = "none";

      try{
        const res = await fetch("/api/crew");
        const data = await res.json();

        if(!Array.isArray(data)) throw new Error("crew data invalid");

        allCrew = data;

        // 필터 옵션 채우기
        const allSkills = uniq(allCrew.flatMap(c=>c.skills||[]));
        const allRoles  = uniq(allCrew.flatMap(c=>c.roles||[]));
        fillSelect(skillEl, allSkills);
        fillSelect(roleEl, allRoles);

        render();
      }catch(e){
        console.error(e);
        directorsEmpty.style.display = "block";
        staffEmpty.style.display = "block";
        directorsEmpty.textContent = "crew 불러오기 실패";
        staffEmpty.textContent = "crew 불러오기 실패";
      }
    }

    [qEl, skillEl, roleEl].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    loadCrew();
  </script>
</body>
</html>