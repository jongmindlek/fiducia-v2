<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
 <link rel="stylesheet" href="./style.css"/>
  <title>Crew | Fiducia</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand">FIDUCIA COLLECTIVE</div>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
        <a class="tab" href="./crew.html#register">감독/스태프 등록</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <h2 style="margin:0 0 12px">crew</h2>

    <div class="card">
      <div class="row">
        <input id="q" class="input" placeholder="이름/키워드 검색" style="flex:1;min-width:180px"/>
        <select id="skill" style="min-width:120px">
          <option value="">Skill 전체</option>
          <option>Film</option>
          <option>Music Video</option>
          <option>Commercial</option>
          <option>Wedding</option>
        </select>
        <select id="role" style="min-width:120px">
          <option value="">Role 전체</option>
          <option>Cinematography</option>
          <option>Lighting</option>
          <option>Sound</option>
          <option>Editing</option>
          <option>Art</option>
          <option>Production</option>
          <option>Directing</option>
        </select>
        <label class="row small" style="gap:6px">
          <input id="verified" type="checkbox"/>
          Verified만
        </label>
      </div>
    </div>

    <div class="section">
      <h3>Directors</h3>
      <div id="directors" class="list"></div>
      <div id="directorsEmpty" class="small" style="display:none;margin-top:8px">Director 불러오는 중...</div>
    </div>

    <div class="section">
      <h3>Staff</h3>
      <div id="staff" class="list"></div>
      <div id="staffEmpty" class="small" style="display:none;margin-top:8px">Staff 불러오는 중...</div>
    </div>

    <div id="register" class="section">
      <h3>crew register</h3>
      <div class="card center">
        <p>감독/스태프 등록은 노션 폼으로 연결하는 방식이 관리가 가장 쉽습니다.<br/>
        아래 버튼 링크를 네 노션 폼 공유 링크로 교체해줘.</p>
        <a class="cta" id="crewFormLink" href="https://notionforms.io/" target="_blank" rel="noreferrer">
          감독/스태프 등록 폼 열기
        </a>
      </div>
    </div>
  </main>

  <script type="module">
    const qs = (id)=>document.querySelector(id);
    const qEl = qs("#q");
    const skillEl = qs("#skill");
    const roleEl = qs("#role");
    const verEl = qs("#verified");

    const dirList = qs("#directors");
    const stfList = qs("#staff");
    const dirEmpty = qs("#directorsEmpty");
    const stfEmpty = qs("#staffEmpty");

    let crews = [];

    const safeThumb = (url)=> url
      ? `<img src="${url}" alt="profile" loading="lazy"/>`
      : `<div class="thumb">no image</div>`;

    function card(c){
      const a = document.createElement("a");
      a.className="card person";
      a.href = `./crew-detail.html?id=${encodeURIComponent(c.id)}`;
      a.innerHTML = `
        <div class="thumb">${safeThumb(c.profileImageUrl)}</div>
        <div class="row" style="justify-content:space-between">
          <div class="name">${c.name || "No name"}</div>
          ${c.verified ? `<span class="badge verified">Verified</span>`:""}
        </div>
        <div class="small">${(c.roles||[]).join(" · ")}</div>
        <div class="tags">
          ${(c.skills||[]).map(s=>`<span class="tag">${s}</span>`).join("")}
        </div>
        <p class="small" style="margin-top:6px">${c.bio || ""}</p>
      `;
      return a;
    }

    function applyFilter(list){
      const q = qEl.value.trim().toLowerCase();
      const skill = skillEl.value;
      const role = roleEl.value;
      const ver = verEl.checked;

      return list.filter(c=>{
        if(ver && !c.verified) return false;
        if(skill && !(c.skills||[]).includes(skill)) return false;
        if(role && !(c.roles||[]).includes(role)) return false;
        if(!q) return true;
        const hay = [
          c.name, c.bio, c.mainRole,
          ...(c.roles||[]), ...(c.skills||[])
        ].join(" ").toLowerCase();
        return hay.includes(q);
      });
    }

    function render(){
      dirList.innerHTML=""; stfList.innerHTML="";
      const filtered = applyFilter(crews);
      const directors = filtered.filter(c=>c.mainRole==="director");
      const staff = filtered.filter(c=>c.mainRole==="staff");

      if(directors.length===0){dirEmpty.style.display="block";dirEmpty.textContent="표시할 Director가 없어요.";}
      else{dirEmpty.style.display="none"; directors.forEach(c=>dirList.appendChild(card(c)));}

      if(staff.length===0){stfEmpty.style.display="block";stfEmpty.textContent="표시할 Staff가 없어요.";}
      else{stfEmpty.style.display="none"; staff.forEach(c=>stfList.appendChild(card(c))); }
    }

    async function load(){
      dirEmpty.style.display="block"; stfEmpty.style.display="block";
      try{
        const res = await fetch("/api/crew");
        crews = await res.json();
        if(!Array.isArray(crews)) crews=[];
      }catch(e){ crews=[]; }
      render();
    }

    [qEl, skillEl, roleEl, verEl].forEach(el=>el.addEventListener("input", render));
    load();
  </script>
</body>
</html>