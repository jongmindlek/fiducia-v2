<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>Gear Reservation</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard-dynamic-subset.css" />
<link rel="stylesheet" href="style.css" />
</head>

<body>
<div class="page"><div class="inner">

  <div class="nav-wrap">
    <nav class="nav">
      <div class="nav-logo">FIDUCIA COLLECTIVE</div>
      <div class="nav-menu">
        <a href="index.html">메인</a>
        <a href="stillcut.html">AI 스틸컷(예약)</a>
        <a href="gear.html" class="is-active">장비 예약</a>
        <a href="crew-list.html">감독/스태프 리스트</a>
        <a href="register.html">감독/스태프 등록</a>
      </div>
    </nav>
  </div>

  <main>
    <h2 class="section-title" style="margin-top:20px;">gear reservation</h2>

    <div id="gear-grid" class="gear-grid">
      <p class="placeholder-text">노션에서 장비 목록을 불러오는 중입니다.</p>
    </div>

    <div class="info-card" style="margin-top:12px;">
      장비 예약 요청은 여기서 바로 입력하면 Gear Reservation DB로 자동 저장됩니다.
    </div>
  </main>

</div></div>

<!-- Modal -->
<div id="gear-modal-backdrop" class="modal-backdrop">
  <div class="modal">
    <div class="modal-head">
      <div class="modal-title" id="gear-modal-title">장비 예약</div>
      <div class="modal-close" id="gear-modal-close">×</div>
    </div>

    <div class="form-grid">
      <div class="form-row"><label>예약자 이름</label><input id="gr-name" placeholder="이름"/></div>
      <div class="form-row"><label>프로젝트명(선택)</label><input id="gr-project" placeholder="예: 뮤비 촬영"/></div>
      <div class="form-row"><label>연락처</label><input id="gr-contact" placeholder="카톡/전화"/></div>
      <div class="form-row"><label>대여 시작일</label><input id="gr-start" type="date"/></div>
      <div class="form-row"><label>대여 종료일(선택)</label><input id="gr-end" type="date"/></div>
      <div class="form-row"><label>요청 메모(선택)</label><textarea id="gr-memo" placeholder="세부요청/시간/픽업 등"></textarea></div>
    </div>

    <div class="form-actions">
      <button class="cta-btn" id="gr-submit" type="button">예약 요청 보내기</button>
    </div>
    <div id="gr-msg" class="form-msg"></div>
  </div>
</div>

<script>
const PLACEHOLDER_IMG = 'https://via.placeholder.com/600x400?text=Gear';
let selectedGearId=null, selectedGearName=null;

async function loadGear(){
  try{
    const res=await fetch('/.netlify/functions/gear');
    const gear=await res.json();
    const grid=document.getElementById('gear-grid');
    grid.innerHTML='';

    (gear||[]).forEach(g=>{
      const card=document.createElement('div');
      card.className='gear-card';
      card.innerHTML=`
        <div class="gear-thumb">${g.thumbnailUrl?`<img src="${g.thumbnailUrl}" alt="${g.name}">`:''}</div>
        <div class="gear-body">
          <div class="gear-name">${g.name||''}</div>
          <div class="gear-meta">${g.brandModel||''}</div>
          <div class="gear-badges">
            ${g.category?`<span class="gear-badge">${g.category}</span>`:''}
            ${g.status?`<span class="gear-badge">${g.status}</span>`:''}
          </div>
          ${g.dayRate?`<div class="gear-rate">Day rate: ${g.dayRate.toLocaleString()}원</div>`:''}
        </div>
        <button class="gear-reserve-btn" data-gear-id="${g.id}" data-gear-name="${g.name||''}">예약하기</button>
      `;
      grid.appendChild(card);
    });

    if(!gear || gear.length===0){
      grid.innerHTML='<p class="placeholder-text">장비가 아직 없습니다.</p>';
    }

    grid.querySelectorAll('.gear-reserve-btn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        selectedGearId = btn.dataset.gearId;
        selectedGearName = btn.dataset.gearName;
        openGearModal();
      });
    });
  }catch(e){console.error(e);}
}

function openGearModal(){
  document.getElementById('gear-modal-title').textContent =
    selectedGearName ? `장비 예약: ${selectedGearName}` : '장비 예약';
  document.getElementById('gr-msg').textContent='';
  document.getElementById('gear-modal-backdrop').style.display='flex';
  document.getElementById('gr-submit').disabled=false;
}
function closeGearModal(){
  document.getElementById('gear-modal-backdrop').style.display='none';
}

async function submitGearReservation(){
  const msg=document.getElementById('gr-msg');
  msg.className='form-msg'; msg.textContent='전송 중...';

  const payload={
    gearId: selectedGearId,
    renterName: document.getElementById('gr-name').value,
    projectName: document.getElementById('gr-project').value,
    contact: document.getElementById('gr-contact').value,
    startDate: document.getElementById('gr-start').value,
    endDate: document.getElementById('gr-end').value,
    memo: document.getElementById('gr-memo').value,
  };

  try{
    const res=await fetch('/.netlify/functions/gear-reservation-create', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });
    const data=await res.json();
    if(!res.ok || !data.ok) throw new Error(data.details||data.message);

    msg.className='form-msg ok';
    msg.textContent='✅ 장비 예약 요청 완료! 확인 후 연락할게.';
    document.getElementById('gr-submit').disabled=true;
  }catch(e){
    msg.className='form-msg bad';
    msg.textContent='❌ 전송 실패: '+(e.message||'');
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  loadGear();
  document.getElementById('gear-modal-close').addEventListener('click', closeGearModal);
  document.getElementById('gear-modal-backdrop').addEventListener('click', (e)=>{
    if(e.target.id==='gear-modal-backdrop') closeGearModal();
  });
  document.getElementById('gr-submit').addEventListener('click', submitGearReservation);
});
</script>
</body>
</html>