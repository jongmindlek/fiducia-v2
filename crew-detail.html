<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="./styles.css"/>
  <title>Crew Detail | Fiducia</title>
</head>
<body>
  <nav class="nav">
    <div class="container nav-inner">
      <div class="brand">FIDUCIA COLLECTIVE</div>
      <div class="nav-links">
        <a class="tab" href="./index.html">메인</a>
        <a class="tab" href="./ai-stillcut.html">AI 스틸컷(예약)</a>
        <a class="tab" href="./gear.html">장비 예약</a>
        <a class="tab active" href="./crew.html">감독/스태프 리스트</a>
      </div>
    </div>
  </nav>

  <main class="container section">
    <a class="small" href="./crew.html">← 목록으로</a>

    <section id="profile" class="card section"></section>

    <section class="card section">
      <h3 style="margin-bottom:8px">Recent Works</h3>
      <div id="works" class="list"></div>
      <div id="worksEmpty" class="small" style="display:none;margin-top:6px">연결된 작업이 아직 없어요.</div>
    </section>
  </main>

  <script type="module">
    const params = new URLSearchParams(location.search);
    const id = params.get("id");

    const profileEl = document.querySelector("#profile");
    const worksEl = document.querySelector("#works");
    const worksEmpty = document.querySelector("#worksEmpty");

    const safeThumb = (url)=> url
      ? `<img src="${url}" alt="img" loading="lazy"/>`
      : `<div class="thumb">no image</div>`;

    async function fetchCrew(){
      const res = await fetch(`/api/crew?id=${encodeURIComponent(id)}`);
      return await res.json();
    }
    async function fetchWorks(){
      const res = await fetch(`/api/works?crewId=${encodeURIComponent(id)}`);
      return await res.json();
    }

    function renderProfile(c){
      const roles = (c.roles||[]).map(r=>`<span class="tag">${r}</span>`).join("");
      const skills = (c.skills||[]).map(s=>`<span class="tag">${s}</span>`).join("");

      profileEl.innerHTML = `
        <div class="kv">
          <div class="avatar">${safeThumb(c.profileImageUrl)}</div>
          <div>
            <div class="row" style="gap:8px;align-items:center">
              <h2>${c.name || "No name"}</h2>
              ${c.verified ? `<span class="badge verified">Verified</span>`:""}
              <span class="badge">${c.mainRole || ""}</span>
            </div>
            <div class="meta" style="margin-top:4px">${(c.roles||[]).join(" · ")}</div>

            <div class="hr"></div>

            <div class="small">Bio</div>
            <p style="margin:6px 0 10px;line-height:1.7">${c.bio || "-"}</p>

            <div class="row" style="margin-top:6px">
              <div>
                <div class="small">Roles</div>
                <div class="tags" style="margin-top:6px">${roles || `<span class="tag">-</span>`}</div>
              </div>
              <div>
                <div class="small">Skills</div>
                <div class="tags" style="margin-top:6px">${skills || `<span class="tag">-</span>`}</div>
              </div>
            </div>

            <div class="actions">
              ${c.instagram ? `<a class="action-btn" href="${c.instagram}" target="_blank">Instagram</a>`:""}
              ${c.phone ? `<a class="action-btn" href="tel:${c.phone}">Call</a>`:""}
              ${c.email ? `<a class="action-btn" href="mailto:${c.email}">Email</a>`:""}
              <a class="action-btn" href="./ai-stillcut.html">AI 스틸컷 예약</a>
              <a class="action-btn" href="./gear.html">장비 예약</a>
            </div>
          </div>
        </div>
      `;
    }

    function renderWorks(list){
      worksEl.innerHTML="";
      if(!Array.isArray(list) || list.length===0){
        worksEmpty.style.display="block";
        return;
      }
      worksEmpty.style.display="none";
      list.forEach(w=>{
        const a = document.createElement("a");
        a.className="card work";
        a.href = w.url || "#";
        a.innerHTML = `
          <div class="wthumb">${safeThumb(w.thumbnailUrl)}</div>
          <div>
            <div style="font-weight:800">${w.title || "Untitled"}</div>
            <div class="small">${w.subTitle || ""}</div>
            <div class="tags" style="margin-top:6px">
              ${w.roleLabel ? `<span class="tag">${w.roleLabel}</span>`:""}
              ${w.roleName ? `<span class="tag">${w.roleName}</span>`:""}
            </div>
          </div>
        `;
        worksEl.appendChild(a);
      });
    }

    async function init(){
      if(!id){
        profileEl.innerHTML="<p>잘못된 접근이에요.</p>";
        return;
      }
      const crew = await fetchCrew();
      renderProfile(crew);

      const works = await fetchWorks();
      renderWorks(works);
    }

    init();
  </script>
</body>
</html>